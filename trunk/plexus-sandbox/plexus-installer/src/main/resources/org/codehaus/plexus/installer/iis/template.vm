;
; Copyright 2005 The Apache Software Foundation.
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;      http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;

; Setup script for NSIS 2.0 (http://nsis.sourceforge.net)
#if ( ${currentDate} )
; Script generated by Maven (http://maven.apache.org) at ${currentDate}
#else
; Script generated by Maven (http://maven.apache.org)
#end
;
; @author <a href="mailto:vincent.siveton@gmail.com">Vincent Siveton</a>

; -----------------------------------------------------------------------------
; Script Defines
; -----------------------------------------------------------------------------
#if ( ${productName} )
Name "${productName}"
#end
#if ( ${productVersion} )
!define PRODUCT_VERSION "${productVersion}"
#end

#if ( ${productCompany} )
!define PRODUCT_COMPANY "${productCompany}"
#else
!define PRODUCT_COMPANY ""
#end
#if ( ${productURL} )
!define PRODUCT_URL "${productURL}"
#else
!define PRODUCT_URL ""
#end

#if ( ${outputFileName} )
!define INSTALLER_NAME "${outputFileName}.exe"
#else
!define INSTALLER_NAME "install.exe"
#end

; -----------------------------------------------------------------------------
; Defines
; -----------------------------------------------------------------------------
!define REGKEY "SOFTWARE\$(^Name)"

; -----------------------------------------------------------------------------
; MUI defines
; -----------------------------------------------------------------------------
!define MUI_ICON "${NSISDIR}\Contrib\Graphics\Icons\modern-install.ico"
!define MUI_FINISHPAGE_NOAUTOCLOSE
!define MUI_LICENSEPAGE_RADIOBUTTONS
!define MUI_STARTMENUPAGE_REGISTRY_ROOT HKLM
!define MUI_STARTMENUPAGE_NODISABLE
!define MUI_STARTMENUPAGE_REGISTRY_KEY Software\$(^Name)
!define MUI_STARTMENUPAGE_REGISTRY_VALUENAME StartMenuGroup
!define MUI_STARTMENUPAGE_DEFAULT_FOLDER $(^Name)
!define MUI_UNICON "${NSISDIR}\Contrib\Graphics\Icons\modern-uninstall.ico"
!define MUI_UNFINISHPAGE_NOAUTOCLOSE
!define MUI_LANGDLL_REGISTRY_ROOT HKLM
!define MUI_LANGDLL_REGISTRY_KEY ${REGKEY}
!define MUI_LANGDLL_REGISTRY_VALUENAME InstallerLanguage

; -----------------------------------------------------------------------------
; Included files
; -----------------------------------------------------------------------------
!include Sections.nsh
!include MUI.nsh

; -----------------------------------------------------------------------------
; Reserved Files
; -----------------------------------------------------------------------------
!insertmacro MUI_RESERVEFILE_LANGDLL

; -----------------------------------------------------------------------------
; Variables
; -----------------------------------------------------------------------------
Var StartMenuGroup

; -----------------------------------------------------------------------------
; Installer pages
; -----------------------------------------------------------------------------
!insertmacro MUI_PAGE_WELCOME
#if ( $productLicense )
  !insertmacro MUI_PAGE_LICENSE $productLicense
#end
!insertmacro MUI_PAGE_DIRECTORY
!insertmacro MUI_PAGE_STARTMENU Application $StartMenuGroup
!insertmacro MUI_PAGE_INSTFILES
!insertmacro MUI_PAGE_FINISH
!insertmacro MUI_UNPAGE_CONFIRM
!insertmacro MUI_UNPAGE_INSTFILES

; Installer languages (first is default language)
!insertmacro MUI_LANGUAGE "English"
!insertmacro MUI_LANGUAGE "Albanian"
!insertmacro MUI_LANGUAGE "Arabic"
!insertmacro MUI_LANGUAGE "Belarusian"
!insertmacro MUI_LANGUAGE "Bosnian"
!insertmacro MUI_LANGUAGE "Breton"
!insertmacro MUI_LANGUAGE "Bulgarian"
!insertmacro MUI_LANGUAGE "Catalan"
!insertmacro MUI_LANGUAGE "Croatian"
!insertmacro MUI_LANGUAGE "Czech"
!insertmacro MUI_LANGUAGE "Danish"
!insertmacro MUI_LANGUAGE "Dutch"
!insertmacro MUI_LANGUAGE "Estonian"
!insertmacro MUI_LANGUAGE "Farsi"
!insertmacro MUI_LANGUAGE "Finnish"
!insertmacro MUI_LANGUAGE "French"
!insertmacro MUI_LANGUAGE "German"
!insertmacro MUI_LANGUAGE "Greek"
!insertmacro MUI_LANGUAGE "Hebrew"
!insertmacro MUI_LANGUAGE "Hungarian"
!insertmacro MUI_LANGUAGE "Icelandic"
!insertmacro MUI_LANGUAGE "Indonesian"
!insertmacro MUI_LANGUAGE "Italian"
!insertmacro MUI_LANGUAGE "Japanese"
!insertmacro MUI_LANGUAGE "Korean"
!insertmacro MUI_LANGUAGE "Kurdish"
!insertmacro MUI_LANGUAGE "Latvian"
!insertmacro MUI_LANGUAGE "Lithuanian"
!insertmacro MUI_LANGUAGE "Luxembourgish"
!insertmacro MUI_LANGUAGE "Macedonian"
!insertmacro MUI_LANGUAGE "Malay"
!insertmacro MUI_LANGUAGE "Mongolian"
!insertmacro MUI_LANGUAGE "Norwegian"
!insertmacro MUI_LANGUAGE "Polish"
!insertmacro MUI_LANGUAGE "Portuguese"
!insertmacro MUI_LANGUAGE "PortugueseBR"
!insertmacro MUI_LANGUAGE "Romanian"
!insertmacro MUI_LANGUAGE "Russian"
!insertmacro MUI_LANGUAGE "Serbian"
!insertmacro MUI_LANGUAGE "SerbianLatin"
!insertmacro MUI_LANGUAGE "SimpChinese"
!insertmacro MUI_LANGUAGE "Slovak"
!insertmacro MUI_LANGUAGE "Slovenian"
!insertmacro MUI_LANGUAGE "Spanish"
!insertmacro MUI_LANGUAGE "Swedish"
!insertmacro MUI_LANGUAGE "Thai"
!insertmacro MUI_LANGUAGE "TradChinese"
!insertmacro MUI_LANGUAGE "Turkish"
!insertmacro MUI_LANGUAGE "Ukrainian"

; -----------------------------------------------------------------------------
; Installer attributes
; -----------------------------------------------------------------------------
OutFile ${INSTALLER_NAME}
InstallDir $PROGRAMFILES\$(^Name)
CRCCheck on
XPStyle on
ShowInstDetails show
VIProductVersion 1.0.0.0
VIAddVersionKey /lang=${LANG_ENGLISH} ProductName $(^Name)
VIAddVersionKey ProductVersion "${VERSION}"
VIAddVersionKey /lang=${LANG_ENGLISH} CompanyName "${PRODUCT_COMPANY}"
VIAddVersionKey /lang=${LANG_ENGLISH} CompanyWebsite "${PRODUCT_URL}"
VIAddVersionKey /lang=${LANG_ENGLISH} FileVersion ""
VIAddVersionKey /lang=${LANG_ENGLISH} FileDescription ""
VIAddVersionKey /lang=${LANG_ENGLISH} LegalCopyright ""
InstallDirRegKey HKLM "${REGKEY}" Path
ShowUninstDetails show

; -----------------------------------------------------------------------------
; Installer sections
; -----------------------------------------------------------------------------
Section -Main SEC0000
    SetOverwrite on
#if ( $files )
  #foreach( $path in $files.keySet() )
    #set ( $file = $files.get( $path ) )
    #set ( $outDirectory = $path.substring( 0, $path.lastIndexOf( "/" ) ) )
    #set ( $outDirectory = $outDirectory.replaceAll( "/", "\\" ) )
    #if ( !$file.isDirectory() )
    SetOutPath "$INSTDIR$outDirectory"
    File "$file"
    #end
  #end
#end
    WriteRegStr HKLM "${REGKEY}\Components" Main 1
SectionEnd

Section -post SEC0001
    WriteRegStr HKLM "${REGKEY}" Path $INSTDIR
    WriteUninstaller $INSTDIR\uninstall.exe
    !insertmacro MUI_STARTMENU_WRITE_BEGIN Application
    SetOutPath $SMPROGRAMS\$StartMenuGroup
    CreateShortCut "$SMPROGRAMS\$StartMenuGroup\$(^UninstallLink).lnk" $INSTDIR\uninstall.exe
    !insertmacro MUI_STARTMENU_WRITE_END
    WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" DisplayName "$(^Name)"
    WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" DisplayVersion "${PRODUCT_VERSION}"
    WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" Publisher "${PRODUCT_COMPANY}"
    WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" URLInfoAbout "${PRODUCT_URL}"
    WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" DisplayIcon $INSTDIR\uninstall.exe
    WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" UninstallString $INSTDIR\uninstall.exe
    WriteRegDWORD HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" NoModify 1
    WriteRegDWORD HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" NoRepair 1
SectionEnd

; Macro for selecting uninstaller sections
!macro SELECT_UNSECTION SECTION_NAME UNSECTION_ID
    Push $R0
    ReadRegStr $R0 HKLM "${REGKEY}\Components" "${SECTION_NAME}"
    StrCmp $R0 1 0 next${UNSECTION_ID}
    !insertmacro SelectSection "${UNSECTION_ID}"
    Goto done${UNSECTION_ID}
    next${UNSECTION_ID}:
        !insertmacro UnselectSection "${UNSECTION_ID}"
    done${UNSECTION_ID}:
        Pop $R0
!macroend

; -----------------------------------------------------------------------------
; Uninstaller sections
; -----------------------------------------------------------------------------
Section /o un.Main UNSEC0000
    ; TODO Maybe we could delete each file and directory installed
    RMDir /R /REBOOTOK $INSTDIR
    DeleteRegValue HKLM "${REGKEY}\Components" Main
SectionEnd

Section un.post UNSEC0001
    DeleteRegKey HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)"
    Delete /REBOOTOK "$SMPROGRAMS\$StartMenuGroup\$(^UninstallLink).lnk"
    Delete /REBOOTOK $INSTDIR\uninstall.exe
    DeleteRegValue HKLM "${REGKEY}" StartMenuGroup
    DeleteRegValue HKLM "${REGKEY}" Path
    DeleteRegKey /ifempty HKLM "${REGKEY}\Components"
    DeleteRegKey /ifempty HKLM "${REGKEY}"
    RMDir /REBOOTOK $SMPROGRAMS\$StartMenuGroup
    RMDir /REBOOTOK $INSTDIR
SectionEnd

; -----------------------------------------------------------------------------
; Installer functions
; -----------------------------------------------------------------------------
Function .onInit
    InitPluginsDir
    !insertmacro MUI_LANGDLL_DISPLAY
FunctionEnd

; -----------------------------------------------------------------------------
; Uninstaller functions
; -----------------------------------------------------------------------------
Function un.onInit
    ReadRegStr $INSTDIR HKLM "${REGKEY}" Path
    ReadRegStr $StartMenuGroup HKLM "${REGKEY}" StartMenuGroup
    !insertmacro MUI_UNGETLANGUAGE
    !insertmacro SELECT_UNSECTION Main ${UNSEC0000}
FunctionEnd

; -----------------------------------------------------------------------------
; Installer Language Strings
; -----------------------------------------------------------------------------
LangString ^UninstallLink ${LANG_ENGLISH} "Uninstall $(^Name)"
;
; Copyright 2005 The Apache Software Foundation.
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;      http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;

; Installer script for InnoSetup 5 (http://www.jrsoftware.org/isinfo.php)
#if ( ${currentDate} )
; Script generated by Maven (http://maven.apache.org) at ${currentDate}
#else
; Script generated by Maven (http://maven.apache.org)
#end
;
; @author <a href="mailto:vincent.siveton@gmail.com">Vincent Siveton</a>

[Setup]
#if ( ${productName} )
AppName="${productName}"
#end
#if ( ${productVersion} )
AppVerName="${productVersion}"
#end
#if ( ${productCompany} )
AppPublisher="${productCompany}"
#end
#if ( ${productURL} )
AppPublisherURL="${productURL}"
AppSupportURL="${productURL}"
AppUpdatesURL="${productURL}"
#end
#if ( ${productName} )
DefaultDirName={pf}\\${productCompany}\\${productName}
DefaultGroupName=${productCompany}\\${productName}
#end
#if ( ${productLicense} )
LicenseFile=${productLicense}
#end
#if ( ${outputFileName} )
OutputBaseFilename=${outputFileName}
#else
OutputBaseFilename=install
#end
OutputDir=.
Compression=lzma
SolidCompression=yes

[Languages]
Name: "eng"; MessagesFile: "compiler:Default.isl"
Name: "bra"; MessagesFile: "compiler:Languages\BrazilianPortuguese.isl"
Name: "cat"; MessagesFile: "compiler:Languages\Catalan.isl"
Name: "cze"; MessagesFile: "compiler:Languages\Czech.isl"
Name: "dan"; MessagesFile: "compiler:Languages\Danish.isl"
Name: "dut"; MessagesFile: "compiler:Languages\Dutch.isl"
Name: "fin"; MessagesFile: "compiler:Languages\Finnish.isl"
Name: "fre"; MessagesFile: "compiler:Languages\French.isl"
Name: "ger"; MessagesFile: "compiler:Languages\German.isl"
Name: "hun"; MessagesFile: "compiler:Languages\Hungarian.isl"
Name: "ita"; MessagesFile: "compiler:Languages\Italian.isl"
Name: "nor"; MessagesFile: "compiler:Languages\Norwegian.isl"
Name: "pol"; MessagesFile: "compiler:Languages\Polish.isl"
Name: "por"; MessagesFile: "compiler:Languages\Portuguese.isl"
Name: "rus"; MessagesFile: "compiler:Languages\Russian.isl"
Name: "slo"; MessagesFile: "compiler:Languages\Slovenian.isl"

[Files]
#if ( $files )
  #foreach( $path in $files.keySet() )
    #set ( $file = $files.get( $path ) )
    #set ( $outDirectory = $path.substring( 0, $path.lastIndexOf( "/" ) ) )
    #set ( $outDirectory = $outDirectory.replaceAll( "/", "\\" ) )
    #if ( !$file.isDirectory() )
Source: "$file"; DestDir: "{app}$outDirectory"; Flags: ignoreversion
    #end
  #end
#end

[Icons]
Name: "{group}\{cm:UninstallProgram,${productName}}"; Filename: "{uninstallexe}"
